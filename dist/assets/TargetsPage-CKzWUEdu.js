import{r,u as Ne,j as e}from"./vendor-react-gZ_13g0c.js";import{b as ie,u as Pe,c as ze}from"./vendor-tanstack-Cuc2T00b.js";import{V as Be,t as b,d as A,q as Ee,Q as qe,W as ue,X as xe,P as Qe,b as G,r as I,v as ee,C as se,B as h,Y as Le,Z as Ke,c as Me,_ as Re,$ as Ue,a0 as He,a1 as Ve,a2 as Ye,a3 as $e,a4 as Je,a5 as We}from"./index-CIGRwQmS.js";import{P as Xe,B as re,D as he,a as ge,b as je,c as ye,d as pe,e as ve,L as E,I as q}from"./label-KQfz7kZ3.js";import{T as _e,a as De,b as Q,c as L}from"./tabs-DXQslPO2.js";import{T as Ze,a as Ge,b as be,c as ae,d as Ie,e as te}from"./table-BjApHs0I.js";import{C as we}from"./checkbox-DN3m8vkQ.js";import{S as de}from"./switch-Cwk0l8Yd.js";import{S as es}from"./separator-CHBem1en.js";import{L as Ce,E as ke,N as Se}from"./EmptyState-GHdAjirr.js";import{d as oe}from"./validation-BBkudM17.js";import{v as ss,f as as,g as Te,O as me,P as fe,Q as ts,h as rs,B as is,R as ls,H as Oe,z as Ae}from"./vendor-icons-DG3TFKsj.js";import"./vendor-tauri-_1WXYKVx.js";import"./vendor-router-g0d7T5Xz.js";function ns(){const c=ie({queryKey:["accounts"],queryFn:Ee}),o=ie({queryKey:["actions"],queryFn:qe});return{accountsQuery:c,actionsQuery:o}}function cs(c,o,t,l){const g=ie({queryKey:["action-overrides",o],queryFn:async()=>{if(!o)return{};const w=await Promise.all(t.map(async d=>{const[f,m]=await Promise.all([ue(d.id,o),xe(d.id,o)]);return[d.id,{hasTargetOverride:!!f,hasDelayOverride:!!m,delayMin:m?.min_seconds,delayMax:m?.max_seconds}]}));return Object.fromEntries(w)},enabled:!!o&&t.length>0}),p=ie({queryKey:["account-overrides",c],queryFn:async()=>{if(!c)return{};const w=await Promise.all(l.map(async d=>{const[f,m]=await Promise.all([ue(c,d.id),xe(c,d.id)]);return[d.id,{hasTargetOverride:!!f,hasDelayOverride:!!m}]}));return Object.fromEntries(w)},enabled:!!c&&l.length>0});return{actionOverrides:g.data??{},accountOverrides:p.data??{},actionOverridesQuery:g,accountOverridesQuery:p}}function ds(){const c=Pe();return ze({mutationFn:({fromId:t,toIds:l,actionIds:g})=>Be(t,l,g),onSuccess:()=>{c.invalidateQueries({queryKey:["targetOverrides"]}),c.invalidateQueries({queryKey:["delayOverrides"]}),c.invalidateQueries({queryKey:["account-overrides"]}),c.invalidateQueries({queryKey:["action-overrides"]})},onError:t=>{b.error("Failed to paste targets",{description:A(t)})}})}function os({open:c,onOpenChange:o,accountId:t,action:l,accountName:g}){const p=Pe(),[w,d]=r.useState("targets"),[f,m]=r.useState(""),[J,K]=r.useState(!0),[P,_]=r.useState(!1),[C,M]=r.useState(2),[k,R]=r.useState(8),[S,U]=r.useState(!1),[T,D]=r.useState([]),[u,j]=r.useState(""),[F,H]=r.useState([]),[z,V]=r.useState(""),[v,Y]=r.useState(""),[N,B]=r.useState(!1),[y,O]=r.useState();r.useEffect(()=>{let a=!1;return c&&(d("targets"),(async()=>await W(()=>a))()),()=>{a=!0}},[c,t,l.id]);const W=async a=>{try{const n=await ue(t,l.id);if(a())return;if(n){_(!0);const i=JSON.parse(n.rule_json);m(i.targets?.join(", ")||""),K(i.random_fallback??!0)}else _(!1),m(""),K(!0);const x=await xe(t,l.id);if(a())return;x?(U(!0),M(x.min_seconds),R(x.max_seconds)):(U(!1),M(2),R(8));const s=await Le(t,l.id);if(a())return;if(D(s),l.is_two_step){const i=await Ke(t,l.id);if(a())return;H(i)}}catch(n){a()||b.error("Failed to load target data",{description:A(n)})}},X=async()=>{if(S){const a=oe(C,k);if(!a.valid){O(a.error),b.error("Invalid delay",{description:a.error});return}}B(!0);try{if(P){const a=f.split(",").map(x=>x.trim()).filter(x=>x),n={type:l.button_type,targets:a,random_fallback:J};await Ye(t,l.id,JSON.stringify(n))}else await $e(t,l.id);S?await Je(t,l.id,C,k):await We(t,l.id),p.invalidateQueries({queryKey:["targetOverrides",t]}),p.invalidateQueries({queryKey:["delayOverrides",t]}),p.invalidateQueries({queryKey:["action-overrides"]}),p.invalidateQueries({queryKey:["account-overrides"]}),o(!1)}catch(a){b.error("Failed to save",{description:A(a)})}finally{B(!1)}},$=async()=>{if(u.trim())try{const a=await Re(t,l.id,u.trim());D([...T,a]),j("")}catch(a){b.error("Failed to add blacklist entry",{description:A(a)})}},le=async a=>{try{await Ue(a),D(T.filter(n=>n.id!==a))}catch(n){b.error("Failed to remove blacklist entry",{description:A(n)})}},ne=async()=>{if(!(!z.trim()||!v.trim()))try{const a=await He(t,l.id,z.trim(),v.trim());H([...F,a]),V(""),Y("")}catch(a){b.error("Failed to add target pair",{description:A(a)})}},ce=async a=>{try{await Ve(a),H(F.filter(n=>n.id!==a))}catch(n){b.error("Failed to remove target pair",{description:A(n)})}};return e.jsx(he,{open:c,onOpenChange:o,children:e.jsxs(ge,{className:"max-w-2xl max-h-[85vh] overflow-hidden flex flex-col",children:[e.jsxs(je,{children:[e.jsxs(ye,{children:["Configure Target: ",l.name]}),e.jsxs(pe,{children:["Account: ",g," â€¢ Button Type: ",l.button_type==="player_list"?"Player List":l.button_type==="yes_no"?"Yes/No":"Fixed"]})]}),e.jsxs(_e,{value:w,onValueChange:a=>d(a),className:"flex-1 overflow-hidden flex flex-col",children:[e.jsxs(De,{className:Me("grid w-full",l.is_two_step?"grid-cols-4":"grid-cols-3"),children:[e.jsxs(Q,{value:"targets",children:[e.jsx(rs,{className:"size-4 mr-1"}),"Targets"]}),e.jsxs(Q,{value:"delay",children:[e.jsx(is,{className:"size-4 mr-1"}),"Delay"]}),e.jsxs(Q,{value:"blacklist",children:[e.jsx(ls,{className:"size-4 mr-1"}),"Blacklist"]}),l.is_two_step&&e.jsxs(Q,{value:"pairs",children:[e.jsx(fe,{className:"size-4 mr-1"}),"Pairs"]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto py-4",children:[e.jsxs(L,{value:"targets",className:"mt-0 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(E,{htmlFor:"use-override",children:"Use custom targets (override default)"}),e.jsx(de,{id:"use-override",checked:P,onCheckedChange:_})]}),P&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"targets",children:"Target Names (priority order)"}),e.jsx(q,{id:"targets",value:f,onChange:a=>m(a.target.value),placeholder:"Player1, Player2, Player3"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Comma-separated list of player names to target in priority order"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"random-fallback",children:"Random Fallback"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pick random target if none from list are available"})]}),e.jsx(de,{id:"random-fallback",checked:J,onCheckedChange:K})]})]}),!P&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Using global default targeting rules for this action."})]}),e.jsxs(L,{value:"delay",className:"mt-0 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(E,{htmlFor:"use-delay-override",children:"Use custom delay (override default)"}),e.jsx(de,{id:"use-delay-override",checked:S,onCheckedChange:U})]}),S&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"min-delay",children:"Min Delay (seconds)"}),e.jsx(q,{id:"min-delay",type:"number",min:0,max:300,value:C,onChange:a=>{const n=parseInt(a.target.value)||0;M(n);const x=oe(n,k);O(x.error)},className:y?"border-destructive":""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"max-delay",children:"Max Delay (seconds)"}),e.jsx(q,{id:"max-delay",type:"number",min:0,max:300,value:k,onChange:a=>{const n=parseInt(a.target.value)||0;R(n);const x=oe(C,n);O(x.error)},className:y?"border-destructive":""})]})]}),y&&e.jsx("p",{className:"text-xs text-destructive",children:y})]}),!S&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Using global default delay (2-8 seconds)."})]}),e.jsxs(L,{value:"blacklist",className:"mt-0 space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{value:u,onChange:a=>j(a.target.value),placeholder:"Enter player name to blacklist",onKeyDown:a=>a.key==="Enter"&&$()}),e.jsx(h,{onClick:$,disabled:!u.trim(),"aria-label":"Add blacklist entry",children:e.jsx(Oe,{className:"size-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Blacklisted players will never be targeted by random selection. Explicit targets always override the blacklist."}),T.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No blacklisted players for this action."}):e.jsx("div",{className:"space-y-2",children:T.map(a=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsx("span",{children:a.button_text}),e.jsx(h,{variant:"ghost",size:"icon-sm",onClick:()=>le(a.id),"aria-label":"Remove blacklist entry",children:e.jsx(Ae,{className:"size-4 text-destructive"})})]},a.id))})]}),l.is_two_step&&e.jsxs(L,{value:"pairs",className:"mt-0 space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{value:z,onChange:a=>V(a.target.value),placeholder:"First target (A)",className:"flex-1"}),e.jsx(q,{value:v,onChange:a=>Y(a.target.value),placeholder:"Second target (B)",className:"flex-1"}),e.jsx(h,{onClick:ne,disabled:!z.trim()||!v.trim(),"aria-label":"Add target pair",children:e.jsx(Oe,{className:"size-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"For two-step actions (like Cupid), define pairs of targets. The first available pair will be used."}),F.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"No pairs configured. Add pairs above or random selection will be used."}):e.jsx("div",{className:"space-y-2",children:F.map((a,n)=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{variant:"outline",children:n+1}),e.jsx("span",{children:a.target_a}),e.jsx(fe,{className:"size-4 text-pink-500"}),e.jsx("span",{children:a.target_b})]}),e.jsx(h,{variant:"ghost",size:"icon-sm",onClick:()=>ce(a.id),"aria-label":"Remove target pair",children:e.jsx(Ae,{className:"size-4 text-destructive"})})]},a.id))})]})]})]}),e.jsx(es,{}),e.jsxs(ve,{children:[e.jsx(h,{variant:"outline",onClick:()=>o(!1),children:"Cancel"}),e.jsx(h,{onClick:X,disabled:N||!!y,children:N?"Saving...":"Save Changes"})]})]})})}function ks(){const[c,o]=r.useState("account"),[t,l]=r.useState(null),[g,p]=r.useState(null),[w,d]=r.useState(!1),[f,m]=r.useState(!1),[J]=Ne(),[K]=Ne(),[P,_]=r.useState(!1),[C,M]=r.useState(null),[k,R]=r.useState(null),[S,U]=r.useState(""),{accountsQuery:T,actionsQuery:D}=ns(),u=T.data??[],j=D.data??[],F=T.isLoading,H=D.isLoading,{actionOverrides:z,accountOverrides:V}=cs(t,g,u,j),[v,Y]=r.useState(null),[N,B]=r.useState(new Set),[y,O]=r.useState(new Set),[W,X]=r.useState(!1),$=s=>{Y(s),B(new Set(j.map(i=>i.id))),d(!0)},le=()=>{d(!1),O(new Set),m(!0)},ne=ds(),ce=async()=>{if(v){X(!0);try{await ne.mutateAsync({fromId:v.id,toIds:[...y],actionIds:[...N]})}finally{X(!1),m(!1),Y(null),B(new Set),O(new Set)}}},a=s=>{const i=new Set(N);i.has(s)?i.delete(s):i.add(s),B(i)},n=s=>{const i=new Set(y);i.has(s)?i.delete(s):i.add(s),O(i)},x=(s,i,Z)=>{R(s),U(i),M(Z),_(!0)};return e.jsxs(Qe,{className:"min-h-screen flex flex-col",children:[e.jsx(Xe,{title:"Targets",description:"Set per-account targeting rules for actions"}),e.jsxs("main",{className:"flex-1 p-6 w-full max-w-6xl mx-auto",children:[e.jsxs(_e,{value:c,onValueChange:s=>o(s),children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs(De,{children:[e.jsxs(Q,{value:"account",children:[e.jsx(ss,{className:"size-4 mr-1"}),"Account-First"]}),e.jsxs(Q,{value:"action",children:[e.jsx(as,{className:"size-4 mr-1"}),"Action-First"]})]})}),e.jsx(L,{value:"account",children:F?e.jsx(Ce,{rows:4}):u.length===0?e.jsx(ke,{icon:e.jsx(Te,{className:"h-8 w-8 text-muted-foreground"}),title:"No accounts yet",description:"Add accounts first to configure targeting rules."}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(G,{children:[e.jsx(I,{children:e.jsx(ee,{className:"text-base",children:"Accounts"})}),e.jsx(se,{className:"p-0",children:e.jsx("div",{className:"divide-y",ref:J,children:u.map(s=>e.jsxs("div",{className:`p-3 cursor-pointer hover:bg-muted/50 flex items-center justify-between ${t===s.id?"bg-muted":""}`,onClick:()=>l(s.id),children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.account_name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.phone||"No phone"})]}),e.jsx(h,{variant:"ghost",size:"icon-sm",onClick:i=>{i.stopPropagation(),$(s)},"aria-label":"Copy targets from account",children:e.jsx(me,{className:"size-4"})})]},s.id))})})]})}),e.jsx("div",{className:"lg:col-span-2",children:t?e.jsxs(G,{children:[e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(ee,{className:"text-base",children:["Targets for ",u.find(s=>s.id===t)?.account_name]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>$(u.find(s=>s.id===t)),children:[e.jsx(me,{className:"size-4 mr-1"}),"Copy Targets"]})]})}),e.jsx(se,{children:j.length===0?e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:"No actions configured yet."}):e.jsx("div",{className:"space-y-3",ref:K,children:j.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:V[s.id]?.hasTargetOverride||V[s.id]?.hasDelayOverride?"Using custom overrides":"Using global defaults"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(re,{variant:"secondary",children:s.button_type==="player_list"?"Player List":s.button_type==="yes_no"?"Yes/No":"Fixed"}),s.is_two_step&&e.jsxs(re,{variant:"outline",className:"text-pink-500 border-pink-500",children:[e.jsx(fe,{className:"size-3 mr-1"}),"Two-Step"]}),e.jsx(h,{variant:"outline",size:"sm",onClick:()=>x(t,u.find(i=>i.id===t)?.account_name||"",s),children:"Configure"})]})]},s.id))})})]}):e.jsx(Se,{itemType:"account"})})]})}),e.jsx(L,{value:"action",children:H?e.jsx(Ce,{rows:4}):j.length===0?e.jsx(ke,{icon:e.jsx(Te,{className:"h-8 w-8 text-muted-foreground"}),title:"No actions yet",description:"Add actions first to configure targeting rules."}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(G,{children:[e.jsx(I,{children:e.jsx(ee,{className:"text-base",children:"Actions"})}),e.jsx(se,{className:"p-0",children:e.jsx("div",{className:"divide-y",children:j.map(s=>e.jsxs("div",{className:`p-3 cursor-pointer hover:bg-muted/50 ${g===s.id?"bg-muted":""}`,onClick:()=>p(s.id),children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:s.button_type==="player_list"?"Player List":s.button_type==="yes_no"?"Yes/No":"Fixed Button"})]},s.id))})})]})}),e.jsx("div",{className:"lg:col-span-2",children:g?e.jsxs(G,{children:[e.jsx(I,{children:e.jsxs(ee,{className:"text-base",children:[j.find(s=>s.id===g)?.name," - Account Targets"]})}),e.jsx(se,{children:u.length===0?e.jsx("div",{className:"text-center py-4 text-muted-foreground",children:"No accounts configured yet."}):e.jsxs(Ze,{children:[e.jsx(Ge,{children:e.jsxs(be,{children:[e.jsx(ae,{children:"Account"}),e.jsx(ae,{children:"Target Rule"}),e.jsx(ae,{children:"Delay"}),e.jsx(ae,{className:"text-right",children:"Actions"})]})}),e.jsx(Ie,{children:u.map(s=>{const i=z[s.id];return e.jsxs(be,{children:[e.jsx(te,{className:"font-medium",children:s.account_name}),e.jsx(te,{children:i?.hasTargetOverride?e.jsx(re,{variant:"default",children:"Custom"}):e.jsx("span",{className:"text-muted-foreground",children:"Default"})}),e.jsx(te,{children:i?.hasDelayOverride?e.jsxs("span",{className:"font-medium",children:[i.delayMin,"-",i.delayMax,"s"]}):e.jsx("span",{className:"text-muted-foreground",children:"Default"})}),e.jsx(te,{className:"text-right",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{const Z=j.find(Fe=>Fe.id===g);Z&&x(s.id,s.account_name,Z)},children:"Configure"})})]},s.id)})})]})})]}):e.jsx(Se,{itemType:"action"})})]})})]}),e.jsx(he,{open:w,onOpenChange:d,children:e.jsxs(ge,{children:[e.jsxs(je,{children:[e.jsx(ye,{children:"Copy Targets"}),e.jsxs(pe,{children:['Select which action targets to copy from "',v?.account_name,'".']})]}),e.jsx("div",{className:"py-4 max-h-64 overflow-y-auto",children:j.map(s=>e.jsxs("div",{className:"flex items-center gap-3 p-2 hover:bg-muted/50 rounded",children:[e.jsx(we,{checked:N.has(s.id),onCheckedChange:()=>a(s.id)}),e.jsx("span",{children:s.name})]},s.id))}),e.jsxs(ve,{children:[e.jsx(h,{variant:"outline",onClick:()=>d(!1),children:"Cancel"}),e.jsxs(h,{onClick:le,disabled:N.size===0,children:[e.jsx(me,{className:"size-4 mr-1"}),"Copy (",N.size,")"]})]})]})}),e.jsx(he,{open:f,onOpenChange:m,children:e.jsxs(ge,{children:[e.jsxs(je,{children:[e.jsx(ye,{children:"Paste Targets"}),e.jsx(pe,{children:"Select accounts to paste targets to. This will overwrite existing targets."})]}),e.jsx("div",{className:"py-4 max-h-64 overflow-y-auto",children:u.filter(s=>s.id!==v?.id).map(s=>e.jsxs("div",{className:"flex items-center gap-3 p-2 hover:bg-muted/50 rounded",children:[e.jsx(we,{checked:y.has(s.id),onCheckedChange:()=>n(s.id)}),e.jsx("span",{children:s.account_name})]},s.id))}),e.jsxs(ve,{children:[e.jsx(h,{variant:"outline",onClick:()=>m(!1),children:"Cancel"}),e.jsxs(h,{onClick:ce,disabled:y.size===0||W,children:[e.jsx(ts,{className:"size-4 mr-1"}),W?"Pasting...":`Paste to (${y.size}) accounts`]})]})]})}),C&&k&&e.jsx(os,{open:P,onOpenChange:_,accountId:k,action:C,accountName:S})]})]})}export{ks as default};
