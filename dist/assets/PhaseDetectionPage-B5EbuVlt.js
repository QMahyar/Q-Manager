import{r as a,u as ge,j as e}from"./vendor-react-gZ_13g0c.js";import{u as pe,b as $,c as D}from"./vendor-tanstack-Cuc2T00b.js";import{P as je,B as W,D as S,a as E,b as k,c as I,d as _,L as d,I as j,e as F}from"./label-KQfz7kZ3.js";import{B as n,G as fe,t as c,H as Pe,d as z,J as ye,K as ve,L as be,M as Ne}from"./index-CIGRwQmS.js";import{S as A}from"./switch-Cwk0l8Yd.js";import{T as Ce,a as we,b as Re,c as Te}from"./tabs-DXQslPO2.js";import{T as De,a as Se,b as X,c as h,d as Ee,e as m}from"./table-BjApHs0I.js";import{R as H,a as Y}from"./RegexTestDialog-CcPsU3yr.js";import{H as f,h as P,R as Z}from"./RegexHelpDialog-CKiLRQxK.js";import{a as ke,H as Ie,J as _e,C as Fe,z as ze}from"./vendor-icons-DG3TFKsj.js";import"./vendor-router-g0d7T5Xz.js";import"./vendor-tauri-_1WXYKVx.js";import"./scroll-area-DAmzG-Zv.js";function $e(){const y=pe(),[r,ee]=a.useState(1),[te,u]=a.useState(!1),[i,v]=a.useState(""),[o,b]=a.useState(!1),[L,O]=a.useState(0),[se,g]=a.useState(!1),[N,q]=a.useState(null),[ae,p]=a.useState(!1),[C,M]=a.useState(null),[l,w]=a.useState(""),[x,R]=a.useState(!1),[B,K]=a.useState(0),[Q,J]=a.useState(!1),[ne]=ge(),{data:U=[]}=$({queryKey:["phases"],queryFn:be}),{data:T=[],isLoading:re}=$({queryKey:["phase-patterns",r],queryFn:()=>Ne(r),enabled:r>0}),ie=D({mutationFn:fe,onSuccess:()=>{y.invalidateQueries({queryKey:["phase-patterns",r]}),u(!1),v(""),b(!1),O(0)}}),V=D({mutationFn:Pe,onSuccess:()=>{y.invalidateQueries({queryKey:["phase-patterns",r]}),c.success("Pattern deleted")},onError:t=>c.error("Failed to delete pattern",{description:z(t)})}),G=D({mutationFn:ye,onSuccess:()=>{y.invalidateQueries({queryKey:["phase-patterns",r]}),p(!1),M(null),c.success("Pattern updated")},onError:t=>c.error("Failed to update pattern",{description:z(t)})}),le=()=>{i.trim()&&ie.mutate({phase_id:r,pattern:i.trim(),is_regex:o,enabled:!0,priority:L})},de=()=>{N&&V.mutate(N.id,{onSettled:()=>{g(!1),q(null)}})},ce=t=>{M(t),w(t.pattern),R(t.is_regex),K(t.priority),p(!0)},oe=()=>{C&&l.trim()&&G.mutate({id:C.id,pattern:l.trim(),is_regex:x,enabled:C.enabled,priority:B})},xe=t=>{G.mutate({id:t.id,pattern:t.pattern,is_regex:t.is_regex,enabled:!t.enabled,priority:t.priority})},he=async()=>{J(!0);try{await ve(),c.success("Patterns reloaded",{description:"Running workers will now use the updated patterns."})}catch(t){c.error("Failed to reload patterns",{description:z(t)})}finally{J(!1)}},me=t=>({join_time:"Detects when a new game is starting and join links are available",join_confirmation:"Detects confirmation messages from the moderator bot in PM",game_start:"Detects when the game has officially started in the group",game_end:"Detects when the game has ended in the group"})[t]||"";return e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(je,{title:"Phase Detection",description:"Configure patterns to detect game phases",children:e.jsxs(n,{variant:"outline",onClick:he,disabled:Q,children:[e.jsx(ke,{className:`size-4 mr-2 ${Q?"animate-spin":""}`}),"Reload Patterns"]})}),e.jsxs("main",{className:"flex-1 p-6 w-full max-w-6xl mx-auto",children:[e.jsxs(Ce,{value:String(r),onValueChange:t=>ee(Number(t)),children:[e.jsx(we,{className:"mb-4",children:U.map(t=>e.jsx(Re,{value:String(t.id),children:t.display_name},t.id))}),U.map(t=>e.jsx(Te,{value:String(t.id),children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-muted/50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:t.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:me(t.name)})]}),e.jsxs(W,{variant:"outline",children:["Priority: ",t.priority]})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"text-sm font-medium",children:["Patterns (",T.length,")"]}),e.jsxs(n,{size:"sm",onClick:()=>u(!0),children:[e.jsx(Ie,{className:"size-4 mr-1"}),"Add Pattern"]})]}),re?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Loading patterns..."}):T.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground border rounded-lg",children:["No patterns configured for this phase.",e.jsx("br",{}),'Click "Add Pattern" to create one.']}):e.jsx("div",{className:"border rounded-lg",children:e.jsxs(De,{children:[e.jsx(Se,{children:e.jsxs(X,{children:[e.jsx(h,{children:"Pattern"}),e.jsx(h,{className:"w-24",children:"Type"}),e.jsx(h,{className:"w-24",children:"Priority"}),e.jsx(h,{className:"w-24",children:"Enabled"}),e.jsx(h,{className:"w-24 text-right",children:"Actions"})]})}),e.jsx(Ee,{ref:ne,children:T.sort((s,ue)=>ue.priority-s.priority).map(s=>e.jsxs(X,{children:[e.jsx(m,{className:"font-mono text-sm",children:s.pattern}),e.jsx(m,{children:e.jsx(W,{variant:s.is_regex?"default":"secondary",children:s.is_regex?"Regex":"Text"})}),e.jsx(m,{children:s.priority}),e.jsx(m,{children:e.jsx(A,{checked:s.enabled,onCheckedChange:()=>xe(s)})}),e.jsx(m,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(H,{pattern:s.pattern,isRegex:s.is_regex,trigger:e.jsx(n,{variant:"ghost",size:"icon-sm",title:"Test pattern","aria-label":"Test pattern",children:e.jsx(_e,{className:"size-4"})})}),e.jsx(n,{variant:"ghost",size:"icon-sm",title:"Edit pattern","aria-label":"Edit pattern",onClick:()=>ce(s),children:e.jsx(Fe,{className:"size-4"})}),e.jsx(n,{variant:"ghost",size:"icon-sm",title:"Delete pattern","aria-label":"Delete pattern",onClick:()=>{q(s),g(!0)},children:e.jsx(ze,{className:"size-4"})})]})})]},s.id))})]})})]})},t.id))]}),e.jsx(S,{open:te,onOpenChange:u,children:e.jsxs(E,{children:[e.jsxs(k,{children:[e.jsx(I,{children:"Add Pattern"}),e.jsx(_,{children:"Add a new detection pattern for this phase."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"pattern",children:"Pattern"}),e.jsx(Y,{pattern:i,isRegex:o})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{id:"pattern",value:i,onChange:t=>v(t.target.value),placeholder:"Enter pattern text or regex...",className:"font-mono flex-1"}),e.jsx(H,{pattern:i,isRegex:o,onPatternChange:v,onIsRegexChange:b})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{children:"Use Regex"}),e.jsx(f,{content:P.regex}),e.jsx(Z,{trigger:e.jsx(n,{variant:"ghost",size:"icon-sm","aria-label":"Regex help",children:"?"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Enable regular expression matching"})]}),e.jsx(A,{checked:o,onCheckedChange:b})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{htmlFor:"priority",children:"Priority"}),e.jsx(f,{content:P.phasePriority})]}),e.jsx(j,{id:"priority",type:"number",value:L,onChange:t=>O(Number(t.target.value)),placeholder:"0"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Lower numbers = higher priority"})]})]}),e.jsxs(F,{children:[e.jsx(n,{variant:"outline",onClick:()=>u(!1),children:"Cancel"}),e.jsx(n,{onClick:le,disabled:!i.trim()||o&&(()=>{try{return new RegExp(i),!1}catch{return!0}})(),children:"Add Pattern"})]})]})}),e.jsx(S,{open:se,onOpenChange:g,children:e.jsxs(E,{children:[e.jsxs(k,{children:[e.jsx(I,{children:"Delete Pattern"}),e.jsx(_,{children:"Are you sure you want to delete this pattern? This action cannot be undone."})]}),e.jsx("div",{className:"py-4",children:e.jsx("code",{className:"block bg-muted p-2 rounded text-sm",children:N?.pattern})}),e.jsxs(F,{children:[e.jsx(n,{variant:"outline",onClick:()=>g(!1),children:"Cancel"}),e.jsx(n,{variant:"destructive",onClick:de,disabled:V.isPending,children:"Delete"})]})]})}),e.jsx(S,{open:ae,onOpenChange:p,children:e.jsxs(E,{children:[e.jsxs(k,{children:[e.jsx(I,{children:"Edit Pattern"}),e.jsx(_,{children:"Modify the detection pattern settings."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{htmlFor:"editPattern",children:"Pattern"}),e.jsx(Y,{pattern:l,isRegex:x})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{id:"editPattern",value:l,onChange:t=>w(t.target.value),placeholder:"Enter pattern text or regex...",className:"font-mono flex-1"}),e.jsx(H,{pattern:l,isRegex:x,onPatternChange:w,onIsRegexChange:R})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{children:"Use Regex"}),e.jsx(f,{content:P.regex}),e.jsx(Z,{trigger:e.jsx(n,{variant:"ghost",size:"icon-sm","aria-label":"Regex help",children:"?"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Enable regular expression matching"})]}),e.jsx(A,{checked:x,onCheckedChange:R})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{htmlFor:"editPriority",children:"Priority"}),e.jsx(f,{content:P.phasePriority})]}),e.jsx(j,{id:"editPriority",type:"number",value:B,onChange:t=>K(Number(t.target.value)),placeholder:"0"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Lower numbers = higher priority"})]})]}),e.jsxs(F,{children:[e.jsx(n,{variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsx(n,{onClick:oe,disabled:!l.trim()||x&&(()=>{try{return new RegExp(l),!1}catch{return!0}})(),children:"Save Changes"})]})]})})]})]})}export{$e as default};
