import{r as o,j as e}from"./vendor-react-gZ_13g0c.js";import{i as me}from"./vendor-tauri-_1WXYKVx.js";import{u as xe,b as w,c as pe}from"./vendor-tanstack-Cuc2T00b.js";import{B as l,m as he,r as S,v as k,z as A,C as G,t as $,d as ge,h as je,A as fe,D as ve,b as Ne,q as ye,E as be,F as Ce}from"./index-CIGRwQmS.js";import{P as _e,L as u,I as y,B as we,D as Se,a as ke,b as Ae,c as Ge,d as Ie,e as Ee}from"./label-KQfz7kZ3.js";import{S as De}from"./switch-Cwk0l8Yd.js";import{a as V,b as I}from"./validation-BBkudM17.js";import{c as Fe,u as Re}from"./vendor-router-g0d7T5Xz.js";import{F as Oe,G as Pe,m as qe,a as Y}from"./vendor-icons-DG3TFKsj.js";const E=he.create(Ne);function We(){const{id:X}=Fe(),Z=Re(),D=xe(),r=parseInt(X||"0"),[b,F]=o.useState(!1),[ee,f]=o.useState(!1),[R,se]=o.useState(1),[O,P]=o.useState(""),[q,z]=o.useState(null),[g,M]=o.useState(""),[p,B]=o.useState(""),[c,L]=o.useState(""),[Q,C]=o.useState([]),[m,h]=o.useState({}),{data:ae=[]}=w({queryKey:["accounts"],queryFn:ye}),t=ae.find(s=>s.id===r),{data:_=[]}=w({queryKey:["group-slots",r],queryFn:async()=>(await be(r),Ce(r)),enabled:r>0}),{data:T=[],isLoading:te,refetch:J,error:re}=w({queryKey:["telegram-groups",r],queryFn:()=>me("account_fetch_groups",{accountId:r}),enabled:!1});o.useEffect(()=>{t&&(M(t.account_name),B(t.join_max_attempts_override?.toString()||""),L(t.join_cooldown_seconds_override?.toString()||""))},[t]),o.useEffect(()=>{_.length>0?C(_):r>0&&C([{id:0,account_id:r,slot:1,enabled:!1,group_id:null,group_title:null,moderator_kind:"main"},{id:0,account_id:r,slot:2,enabled:!1,group_id:null,group_title:null,moderator_kind:"main"}])},[_,r]);const ne=()=>{let s=!0;const a={};if(g.trim()){const n=V(g);n.valid||(a.accountName=n.error,s=!1)}if(p||c){const n=parseInt(p)||5,i=parseInt(c)||5,d=I(n,i);d.valid||(a.joinRules=d.error,s=!1)}return h(a),s},K=c?(()=>{const s=parseInt(c)||0;return s<=0?"Cooldown is set to 0 seconds. This may cause rapid join attempts.":s<2?"Cooldown is very low. Consider 2+ seconds to avoid rapid retries.":""})():"",v=pe({mutationFn:async()=>{if(!ne())throw new Error("Please fix validation errors before saving");const s=t?.account_name||"";if(g.trim().toLowerCase()!==s.toLowerCase()&&await je(g.trim()))throw h(n=>({...n,accountName:"An account with this name already exists"})),new Error("An account with this name already exists");await fe("account_update",{payload:{id:r,account_name:g,join_max_attempts_override:p?parseInt(p):null,join_cooldown_seconds_override:c?parseInt(c):null}});for(const a of Q)await ve(r,a.slot,{enabled:a.enabled,group_id:a.group_id,group_title:a.group_title,moderator_kind:a.moderator_kind})},onSuccess:()=>{D.invalidateQueries({queryKey:["accounts"]}),D.invalidateQueries({queryKey:["group-slots",r]}),F(!1),$.success("Account saved")},onError:s=>{$.error("Failed to save",{description:ge(s)})}}),N=()=>{b||F(!0)},j=(s,a)=>{C(n=>{const i=n.map(x=>x.slot===s?{...x,...a}:x),d=i.filter(x=>x.enabled&&x.group_id),le=d.find((x,ce)=>d.some((de,ue)=>ue!==ce&&de.group_id===x.group_id));return z(le?"Both slots reference the same group. Consider picking different groups.":null),i}),N()},H=()=>{v.mutate()},W=s=>{se(s),P(""),f(!0),J()},oe=s=>{j(R,{group_id:s.id,group_title:s.title}),f(!1)},ie=s=>{j(s,{group_id:null,group_title:null})},U=T.filter(s=>s.title.toLowerCase().includes(O.toLowerCase()));return t?e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(_e,{title:"Edit Account",description:t.telegram_name||t.phone||`ID: ${t.user_id}`,backTo:"/accounts",children:e.jsxs(l,{onClick:H,disabled:!b||v.isPending,children:[e.jsx(Pe,{className:"size-4 mr-1"}),v.isPending?"Saving...":"Save Changes"]})}),e.jsxs("main",{className:"flex-1 p-6 space-y-6 w-full max-w-3xl mx-auto",children:[e.jsxs(E,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:0},children:[e.jsxs(S,{children:[e.jsx(k,{children:"Account Information"}),e.jsx(A,{children:"Basic account details"})]}),e.jsxs(G,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"accountName",children:"Account Name"}),e.jsx(y,{id:"accountName",value:g,onChange:s=>{M(s.target.value);const a=V(s.target.value);h(n=>({...n,accountName:a.error})),N()},className:m.accountName?"border-destructive":""}),m.accountName&&e.jsx("p",{className:"text-xs text-destructive",children:m.accountName})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{className:"text-muted-foreground",children:"Telegram Name"}),e.jsx("p",{className:"text-sm",children:t.telegram_name||"-"})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-muted-foreground",children:"Phone"}),e.jsx("p",{className:"text-sm",children:t.phone||"-"})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-muted-foreground",children:"User ID"}),e.jsx("p",{className:"text-sm font-mono",children:t.user_id||"-"})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-muted-foreground",children:"Status"}),e.jsx("p",{className:"text-sm",children:e.jsx(we,{variant:t.status==="running"?"default":"secondary",children:t.status})})]})]})]})]}),e.jsxs(E,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.08},children:[e.jsxs(S,{children:[e.jsx(k,{children:"Game Groups"}),e.jsx(A,{children:"Configure up to 2 Werewolf game groups for this account"})]}),e.jsxs(G,{className:"space-y-6",children:[q&&e.jsx("div",{className:"rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-800",children:q}),Q.map(s=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("h4",{className:"font-medium",children:["Slot ",s.slot]}),e.jsx(De,{checked:s.enabled,onCheckedChange:a=>j(s.slot,{enabled:a})}),e.jsx("span",{className:"text-sm text-muted-foreground",children:s.enabled?"Enabled":"Disabled"})]})}),s.enabled&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{children:"Game Group"}),e.jsxs("div",{className:"flex gap-2",children:[s.group_title?e.jsxs("div",{className:"flex-1 flex items-center justify-between border rounded-md px-3 py-2",children:[e.jsx("span",{children:s.group_title}),e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>ie(s.slot),children:"Clear"})]}):e.jsxs(l,{variant:"outline",className:"flex-1",onClick:()=>W(s.slot),children:[e.jsx(qe,{className:"size-4 mr-2"}),"Select Group"]}),e.jsx(l,{variant:"outline",size:"icon",onClick:()=>W(s.slot),children:e.jsx(Y,{className:"size-4"})})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{children:"Moderator Bot"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(l,{variant:s.moderator_kind==="main"?"default":"outline",size:"sm",onClick:()=>j(s.slot,{moderator_kind:"main"}),children:"Main Bot"}),e.jsx(l,{variant:s.moderator_kind==="beta"?"default":"outline",size:"sm",onClick:()=>j(s.slot,{moderator_kind:"beta"}),children:"Beta Bot"})]})]})]})]},s.slot))]})]}),e.jsxs(E,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3,delay:.24},children:[e.jsxs(S,{children:[e.jsx(k,{children:"Join Rules Overrides"}),e.jsx(A,{children:"Override global join settings for this account (leave empty to use global defaults)"})]}),e.jsxs(G,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"joinMaxAttemptsOverride",children:"Max Join Attempts"}),e.jsx(y,{id:"joinMaxAttemptsOverride",type:"number",value:p,onChange:s=>{if(B(s.target.value),s.target.value||c){const a=parseInt(s.target.value)||5,n=parseInt(c)||5,i=I(a,n);h(d=>({...d,joinRules:i.error}))}else h(a=>({...a,joinRules:void 0}));N()},placeholder:"Use global default (5)",className:m.joinRules?"border-destructive":""})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"joinCooldownOverride",children:"Cooldown (seconds)"}),e.jsx(y,{id:"joinCooldownOverride",type:"number",value:c,onChange:s=>{const a=parseInt(s.target.value)||5,n=parseInt(p)||5;if(s.target.value||p){const i=I(n,a);h(d=>({...d,joinRules:i.error}))}else h(i=>({...i,joinRules:void 0}));L(s.target.value),N()},placeholder:"Use global default (5)",className:m.joinRules?"border-destructive":""})]})]}),m.joinRules&&e.jsx("p",{className:"text-xs text-destructive",children:m.joinRules}),!m.joinRules&&K&&e.jsx("p",{className:"text-xs text-warning",children:K})]})]}),b&&e.jsxs("div",{className:"fixed bottom-6 right-6 bg-primary text-primary-foreground px-4 py-2 rounded-lg shadow-lg flex items-center gap-3",children:[e.jsx("span",{children:"You have unsaved changes"}),e.jsx(l,{variant:"secondary",size:"sm",onClick:H,disabled:v.isPending,children:"Save Now"})]})]}),e.jsx(Se,{open:ee,onOpenChange:f,children:e.jsxs(ke,{className:"max-w-md",children:[e.jsxs(Ae,{children:[e.jsx(Ge,{children:"Select Game Group"}),e.jsxs(Ie,{children:["Choose a group for Slot ",R]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{placeholder:"Search groups...",value:O,onChange:s=>P(s.target.value)}),e.jsx(l,{variant:"outline",onClick:()=>J(),children:e.jsx(Y,{className:"size-4"})})]}),e.jsx("div",{className:"max-h-64 overflow-y-auto border rounded-md",children:te?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"Loading groups..."}):re?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:"Failed to load groups. Ensure the account is logged in and try again."}):U.length===0?e.jsx("div",{className:"p-4 text-center text-muted-foreground",children:T.length===0?"No groups found. Start the account once to refresh chats, then try again.":"No groups match your search."}):e.jsx("div",{className:"divide-y",children:U.map(s=>e.jsxs("div",{className:"p-3 hover:bg-muted/50 cursor-pointer",onClick:()=>oe(s),children:[e.jsx("div",{className:"font-medium",children:s.title}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[s.group_type,s.member_count&&` â€¢ ${s.member_count} members`]})]},s.id))})})]}),e.jsx(Ee,{children:e.jsx(l,{variant:"outline",onClick:()=>f(!1),children:"Cancel"})})]})})]}):e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx("header",{className:"border-b border-border px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>Z("/accounts"),children:e.jsx(Oe,{className:"h-5 w-5"})}),e.jsx("div",{children:e.jsx("h1",{className:"text-xl font-bold text-foreground",children:"Account Not Found"})})]})}),e.jsx("main",{className:"flex-1 p-6 flex items-center justify-center",children:e.jsx("p",{className:"text-muted-foreground",children:"The requested account does not exist."})})]})}export{We as default};
